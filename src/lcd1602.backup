#include <Arduino.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// LCD åˆå§‹åŒ–ï¼šä½å€ç‚º 0x27ã€è¢å¹•ç‚º 16x2
LiquidCrystal_I2C lcd(0x27, 16, 2);

// LED è…³ä½
#define RED_LED     2
#define YELLOW_LED  3
#define GREEN_LED   4
#define BUTTON_PIN  5

// ç‹€æ…‹èˆ‡è¡Œäººè«‹æ±‚
volatile bool pedestrianRequest = false;
enum TrafficState { GREEN, YELLOW, RED };
volatile TrafficState currentState = RED;

// å‰ç½®å®£å‘Š
void IRAM_ATTR onPedestrianButtonPress();
void showStatus(String label, int seconds, bool pedestrian);

void setup() {
  Wire.begin(6, 7);  // SDA = GPIO 6, SCL = GPIO 7
  pinMode(RED_LED, OUTPUT);
  pinMode(YELLOW_LED, OUTPUT);
  pinMode(GREEN_LED, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  Serial.begin(115200);
  delay(1000);
  Serial.println("ğŸš¦ Traffic Light + LCD");

  attachInterrupt(digitalPinToInterrupt(BUTTON_PIN), onPedestrianButtonPress, FALLING);

  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("Traffic Light");
  delay(1500);
  lcd.clear();
}

void loop() {
  // ğŸŸ¢ ç¶ ç‡ˆ
  currentState = GREEN;
  digitalWrite(GREEN_LED, HIGH);
  digitalWrite(YELLOW_LED, LOW);
  digitalWrite(RED_LED, LOW);
  Serial.println("ğŸŸ¢ Green Light");
  showStatus("Green", 5, false);

  // ğŸŸ¡ é»ƒç‡ˆ
  currentState = YELLOW;
  digitalWrite(GREEN_LED, LOW);
  digitalWrite(YELLOW_LED, HIGH);
  Serial.println("ğŸŸ¡ Yellow Light");
  showStatus("Yellow", 2, false);

  // ğŸ”´ ç´…ç‡ˆ
  currentState = RED;
  digitalWrite(YELLOW_LED, LOW);
  digitalWrite(RED_LED, HIGH);
  Serial.println("ğŸ”´ Red Light");

  if (pedestrianRequest) {
    Serial.println("ğŸš¶ Pedestrian Wait (Extended)");
    showStatus("Red", 8, true);
    pedestrianRequest = false;
  } else {
    showStatus("Red", 5, false);
  }
}

// é¡¯ç¤ºäº¤é€šç‡ˆèˆ‡å€’æ•¸ç§’æ•¸
void showStatus(String label, int seconds, bool pedestrian) {
  for (int i = seconds; i > 0; i--) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(label + " Light");

    lcd.setCursor(0, 1);
    lcd.print("Time: " + String(i) + "s");

    if (pedestrian) {
      lcd.setCursor(10, 1);
      lcd.print("*");
    }

    Serial.print(label);
    Serial.print(": ");
    Serial.print(i);
    Serial.println("s");

    delay(1000);
  }
}

// ä¸­æ–·å‡½å¼ï¼šåªåœ¨ç¶ ç‡ˆç‹€æ…‹æ¥å—è«‹æ±‚
void IRAM_ATTR onPedestrianButtonPress() {
  if (currentState == GREEN) {
    pedestrianRequest = true;
  }
}
