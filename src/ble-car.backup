#include <Arduino.h>
#include <NimBLEDevice.h>

// é¦¬é”æ§åˆ¶è…³ä½å®šç¾©
#define IN1 1  // å·¦é¦¬é”
#define IN2 2
#define IN3 3  // å³é¦¬é”
#define IN4 4

// æ¿è¼‰ LED è…³ä½
#define LED_PIN 8

// å‹•ä½œç‹€æ…‹å®šç¾©
enum MotionState { STOPPED, FORWARD, OTHER };
MotionState currentState = STOPPED;

unsigned long lastBlinkTime = 0;
bool ledState = false;

// === LED ç‹€æ…‹æ§åˆ¶ ===
void updateLED() {
  unsigned long now = millis();

  if (currentState == FORWARD) {
    digitalWrite(LED_PIN, LOW); // å‰é€² â†’ é—œç‡ˆ
  } else if (currentState == STOPPED) {
    digitalWrite(LED_PIN, HIGH); // åœæ­¢ â†’ äº®ç‡ˆ
  } else {
    // è½‰å½ã€å¾Œé€€ â†’ é–ƒçˆ
    if (now - lastBlinkTime >= 500) {
      ledState = !ledState;
      digitalWrite(LED_PIN, ledState ? LOW : HIGH);
      lastBlinkTime = now;
    }
  }
}

// === é¦¬é”å‹•ä½œå‡½å¼ ===
void moveForward() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);  // å·¦é¦¬é”å‰é€²
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);  // å³é¦¬é”å‰é€²
  currentState = FORWARD;
}

void moveBackward() {
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH); // å·¦é¦¬é”å¾Œé€€
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH); // å³é¦¬é”å¾Œé€€ (ä¿®æ­£é)
  currentState = OTHER;
}

void turnLeft() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);  // å·¦é¦¬é”å¾Œé€€
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);  // å³é¦¬é”å‰é€²
  currentState = OTHER;
}

void turnRight() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);  // å·¦é¦¬é”å‰é€²
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH); // å³é¦¬é”å¾Œé€€
  currentState = OTHER;
}

void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
  currentState = STOPPED;
}

// === BLE UART æœå‹™è¨­å®š ===
NimBLECharacteristic* pCharacteristic;

class BLEUARTCallback : public NimBLECharacteristicCallbacks {
  void onWrite(NimBLECharacteristic* pChar) override {
    std::string cmd = pChar->getValue();
    if (cmd.length() == 0) return;

    char c = toupper(cmd[0]);  // ğŸ‘‰ æ”¯æ´å¤§å°å¯«
    Serial.printf("ğŸ”µ Received: %c\n", c);

    switch (c) {
      case 'F': moveForward(); break;
      case 'B': moveBackward(); break;
      case 'L': turnLeft();    break;
      case 'R': turnRight();   break;
      case 'S': stopMotors();  break;
    }
  }
};

void setupBLE() {
  NimBLEDevice::init("ESP32C3-Car");
  NimBLEServer* pServer = NimBLEDevice::createServer();

  NimBLEService* pService = pServer->createService("6E400001-B5A3-F393-E0A9-E50E24DCCA9E"); // UART
  pCharacteristic = pService->createCharacteristic(
    "6E400002-B5A3-F393-E0A9-E50E24DCCA9E",
    NIMBLE_PROPERTY::WRITE
  );

  pCharacteristic->setCallbacks(new BLEUARTCallback());
  pService->start();

  NimBLEAdvertising* pAdvertising = NimBLEDevice::getAdvertising();
  pAdvertising->start();

  Serial.println("ğŸ“¶ BLE UART ready, device name: ESP32C3-Car");
}

void setup() {
  Serial.begin(115200);
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, HIGH); // é è¨­ STOP ç‹€æ…‹äº®ç‡ˆ
  stopMotors();

  setupBLE();
}

void loop() {
  updateLED();
  delay(10);
}
